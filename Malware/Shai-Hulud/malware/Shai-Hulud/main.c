#include <windows.h>
#include <winhttp.h>
#include <stdio.h>
#include <stdlib.h>

#pragma comment(lib, "winhttp.lib")

BOOL MakePostRequest(const wchar_t* server, int port, const wchar_t* path, wchar_t* user_agent, wchar_t* custom_header) {
    HINTERNET hSession = NULL, hConnect = NULL, hRequest = NULL;
    BOOL bResults = FALSE;
    DWORD dwStatusCode = 0;
    DWORD dwStatusSize = sizeof(dwStatusCode);

    // Use WinHttpOpen to obtain a session handle.
    hSession = WinHttpOpen(user_agent, WINHTTP_ACCESS_TYPE_DEFAULT_PROXY, WINHTTP_NO_PROXY_NAME, WINHTTP_NO_PROXY_BYPASS, 0);

    // Specify an HTTP server.
    if (hSession)
        hConnect = WinHttpConnect(hSession, server, port, 0);

    // Create an HTTP request handle.
    if (hConnect)
        hRequest = WinHttpOpenRequest(hConnect, L"POST", path, NULL, WINHTTP_NO_REFERER, WINHTTP_DEFAULT_ACCEPT_TYPES, 0);

    // Add custom headers to the request.
    if (hRequest)
        bResults = WinHttpAddRequestHeaders(hRequest, custom_header, -1L, WINHTTP_ADDREQ_FLAG_ADD);

    // Send a request without any POST data.
    if (hRequest)
        bResults = WinHttpSendRequest(hRequest, WINHTTP_NO_ADDITIONAL_HEADERS, 0, WINHTTP_NO_REQUEST_DATA, 0, 0, 0);

    // End the request.
    if (bResults)
        bResults = WinHttpReceiveResponse(hRequest, NULL);

    // Check the response status code.
    if (bResults)
        bResults = WinHttpQueryHeaders(hRequest, WINHTTP_QUERY_STATUS_CODE | WINHTTP_QUERY_FLAG_NUMBER, WINHTTP_HEADER_NAME_BY_INDEX, &dwStatusCode, &dwStatusSize, WINHTTP_NO_HEADER_INDEX);

    // Close open handles.
    if (hRequest) WinHttpCloseHandle(hRequest);
    if (hConnect) WinHttpCloseHandle(hConnect);
    if (hSession) WinHttpCloseHandle(hSession);

    if (bResults && dwStatusCode == 200) {
        return TRUE;
    } else {
        return FALSE;
    }
}

int main(void) {
    const wchar_t* server = L"localhost";
    const wchar_t* path = L"/";
    int port = 8000;
    volatile wchar_t* user_agent = L"Arrakis/0.2";
    volatile wchar_t* custom_header = L"Stage2: GreenWillow.7z";

    if (MakePostRequest(server, port, path, user_agent, custom_header)) {
        printf("Request succeeded.\n");
    }
    else {
        printf("Request failed.\n");
    }

    return 0;
}
