from flask import Flask, request, redirect, render_template, make_response, url_for
import random

app = Flask(__name__)

# List of random quotes or phrases
HEADER_KEY = 'Stage2'
HEADER_VALUE = 'GreenWillow.iso'
USER_AGENT = 'Arrakis/0.2'

QUOTES = [
    "Use the first moments in study. You may miss many an opportunity for quick victory this way, but the moments of study are insurance of success. Take your time and be sure.",
    "Once men turned their thinking over to machines in the hope that this would set them free. But that only permitted other men with machines to enslave them.",
    "The power to destroy a thing is the absolute control over it.",
    "Out of the sand haze came an ordely mass of flashing shapes - great rising curves with crystal spokes that resolved into the gaping mouths of sandworms, a massed wall of them, each with troops of Fremen riding to the attack. They came in a hissing wedge, robes whipping in the wind as they cut through the melee on the plain.",
    "Treachery within treachery within treachery.",
    "The concept of progress acts as a protective mechanism to shield us from the terrors of the future.",
    "I must not fear. Fear is the mind-killer. Fear is the little-death that brings total obliteration. I will face my fear. I will permit it to pass over me and through me. And when it has gone past I will turn the inner eye to see its path. Where the fear has gone there will be nothing. Only I will remain.",
    "Hope clouds observation.",
    "He who controls the spice controls the universe.",
    "Any road followed precisely to its end leads precisely nowhere. Climb the mountain just a little bit to test that it's a mountain. From the top of the mountain, you cannot see the mountain."
    "The willow submits to the wind and prospers until one day it is many willows - a wall against the wind.",
    "Any man who retreats into a cave which has only one opening deserves to die.",
    "Thou shalt not make a machine in the likeness of a human mind.",
    "If you rely only on your eyes, your other senses weaken.",
]

def get_flag():
    with open('/flag.txt', 'r') as f:
        return f.read().strip()


@app.route('/', methods=['GET'])
def index():
    headers = request.headers
    if headers.get(HEADER_KEY) == HEADER_VALUE and headers.get('User-Agent') == USER_AGENT:
        return redirect(url_for('stage2', filename='GreenWillow.iso') ,code=302)
    else:
        random_quote = random.choice(QUOTES)
        return render_template('index.html', random_quote=random_quote)


@app.route('/stage2/<filename>', methods=['GET'])
def stage2(filename):
    headers = request.headers
    if headers.get(HEADER_KEY) == HEADER_VALUE and headers.get('User-Agent') == USER_AGENT:
        response = make_response(f'Valid victim host found.\nDownloading stage 2: {filename}\n')
        response.headers['Flag'] = get_flag()
        return response
    else:
        return redirect('/', code=302)

if __name__ == '__main__':
    app.run(debug=True, port=8000)
